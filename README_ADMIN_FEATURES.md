# 🎯 SafeGram - Новые функции для администраторов

## 📊 Обзор изменений

| Функция | Статус | Описание |
|---------|--------|----------|
| 📧 Персональные письма | ✅ Готово | Отправка email конкретным пользователям |
| 🔧 Технические работы | ✅ Готово | Баннер для всех + email-рассылка |
| 📞 Входящие звонки | ✅ Исправлено | Уведомление с кнопками принять/отклонить |
| 🔑 Дубликаты ключей | ✅ Исправлено | Нет warning в консоли |

---

## 🎨 Визуальный обзор:

### 📧 Персональное письмо от администрации

```
┌─────────────────────────────────────────┐
│        SafeGram (градиент фон)          │
├─────────────────────────────────────────┤
│                                         │
│  📨 Сообщение от администрации          │
│                                         │
│  Здравствуйте, Иван!                    │
│                                         │
│  У нас есть для вас важное сообщение:   │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │  Персональное сообщение здесь     │  │
│  │  от администратора                │  │
│  └───────────────────────────────────┘  │
│                                         │
│        [ Кнопка с действием ]           │
│                                         │
│  ─────────────────────────────────────  │
│                                         │
│  SafeGram - Безопасный мессенджер       │
│  © 2024 SafeGram. Все права защищены.   │
│                                         │
└─────────────────────────────────────────┘
```

**Где настроить:** Админка → "📧 Письма & Тех.работы" → "Персональные письма"

---

### 🔧 Баннер о технических работах

**На сайте (для всех пользователей):**

```
╔═════════════════════════════════════════════════════╗
║  ⚠️  Плановые технические работы              ❌  ║
║                                                     ║
║  ⏰ Время: 26 января 2024, с 02:00 до 04:00 (МСК)  ║
║  ℹ️ Во время работ доступ может быть ограничен     ║
╚═════════════════════════════════════════════════════╝
    [остальной контент сайта ниже]
```

**Особенности:**
- 🟡 Жёлто-оранжевый градиент
- ⚠️ Анимированная иконка (пульсация)
- ❌ Кнопка закрыть (состояние сохраняется)
- 📱 Адаптивный для мобильных
- 🔄 Автопроверка каждые 5 минут

**Где настроить:** Админка → "📧 Письма & Тех.работы" → "Технические работы"

---

### 📞 Уведомление о входящем звонке

**Что видит пользователь при звонке:**

```
╔═══════════════════════════════════╗
║                                   ║
║       [Аватар звонящего]          ║
║         (с пульсацией)            ║
║                                   ║
║      Иван Иванов                  ║
║   📹 Входящий видеозвонок         ║
║                                   ║
║   [ Отклонить ]  [ Принять ]      ║
║                                   ║
║   ═════════════════════ 30s       ║
╚═══════════════════════════════════╝

🔔 Звучит рингтон
```

**Функции:**
- 🔔 Звуковой рингтон (Web Audio API)
- 📱 Браузерные уведомления
- ⏰ Автоотклонение через 30 секунд
- 👤 Аватар и имя звонящего
- 📹 Иконка видео/аудио

**Как протестировать:** Откройте 2 вкладки с разными аккаунтами и позвоните

---

## 🎯 Админ-панель: новый таб

### Где находится:

```
Панель управления (Admin Panel)
┌────────────────────────────────────────────────┐
│ 👥 Пользователи │ 📊 Аналитика │ ... │        │
│ 📧 Письма & Тех.работы ← НОВЫЙ ТАБ!           │
└────────────────────────────────────────────────┘

Внутри таба 2 раздела:
  1. 📧 Персональные письма
  2. 🔧 Технические работы
```

### Форма персональных писем:

```
┌─────────────────────────────────────┐
│ ID пользователя: [________]         │
│                                     │
│ Сообщение:                          │
│ [_________________________________] │
│ [_________________________________] │
│                                     │
│ Текст кнопки: [________]            │
│ Ссылка: [____________________]      │
│                                     │
│      [ 📨 Отправить письмо ]        │
└─────────────────────────────────────┘
```

### Форма технических работ:

```
┌─────────────────────────────────────┐
│ ⚠️ Активация покажет баннер всем!   │
│                                     │
│ Время работ:                        │
│ [26 января, 02:00-04:00 (МСК)]      │
│                                     │
│ Описание:                           │
│ [_________________________________] │
│ [_________________________________] │
│                                     │
│ ☑️ Отправить email всем             │
│                                     │
│  [ ⚠️ Активировать ] [ ✅ Отключить ]│
└─────────────────────────────────────┘
```

---

## 🔐 Безопасность и права доступа:

| Действие | Требуется роль |
|----------|----------------|
| Отправить персональное письмо | admin или owner |
| Активировать тех. работы | admin или owner |
| Просмотреть статус тех. работ | Все (публичный API) |
| Отключить тех. работы | admin или owner |

---

## 📡 API Endpoints (для разработчиков):

### Персональные письма:
```http
POST /api/admin/send-email
Body: {
  "userId": "user-id",
  "message": "Текст",
  "actionText": "Открыть",
  "actionLink": "https://..."
}
```

### Технические работы:
```http
POST /api/admin/maintenance
Body: {
  "timestamp": "26 января, 02:00-04:00",
  "message": "Описание работ",
  "sendEmail": true
}

GET /api/maintenance/status
Response: {
  "isActive": true,
  "timestamp": "...",
  "message": "..."
}

POST /api/admin/maintenance/disable
```

---

## 📊 Сценарии использования:

### Сценарий 1: Персональный ответ пользователю

**Задача:** Пользователь написал в поддержку, нужно ответить

**Решение:**
1. Найдите ID пользователя (Админка → Пользователи)
2. Перейдите в "📧 Письма & Тех.работы"
3. Отправьте персональное письмо:
   ```
   Здравствуйте! Мы проверили вашу проблему.
   Исправление будет в следующем обновлении.
   ```
4. Добавьте кнопку "Следить за обновлениями"

### Сценарий 2: Плановое обновление сервера

**Задача:** Нужно обновить сервер ночью, предупредить пользователей

**Решение:**
1. **За день до работ:**
   - Активируйте режим тех. работ
   - Время: "26 января, с 03:00 до 05:00 (МСК)"
   - Описание: "Обновление базы данных"
   - ✓ Отправить email всем
   
2. **Пользователи увидят:**
   - Баннер на сайте
   - Email-уведомление

3. **После завершения:**
   - Нажмите "Отключить"
   - Баннер исчезнет у всех

### Сценарий 3: Срочная проблема

**Задача:** Обнаружен баг, работаем над исправлением

**Решение:**
1. Активируйте режим БЕЗ email:
   - Время: "Прямо сейчас, ~30 минут"
   - Описание: "Исправляем проблему с отправкой сообщений"
2. Все увидят баннер
3. После исправления - отключите

---

## 💾 База данных:

### Новая таблица:
```sql
CREATE TABLE maintenance_modes (
    id UUID PRIMARY KEY,
    is_active BOOLEAN DEFAULT false,
    timestamp VARCHAR(255),
    message TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**Автоматически создаётся** при запуске Go сервера (через GORM AutoMigrate).

---

## ⚡ Быстрый старт (3 шага):

### Шаг 1: Запустите серверы
```bash
# Terminal 1 - Backend
cd server-go
go run main.go

# Terminal 2 - Frontend
cd web
npm run dev
```

### Шаг 2: Откройте админку
```
http://localhost:5173/app/admin
```

### Шаг 3: Протестируйте
- Отправьте персональное письмо
- Активируйте тех. работы
- Проверьте баннер

---

## 🎨 Дизайн:

### Цветовая схема:
- **Персональные письма:** Градиент #7c6cff → #3dd8ff
- **Баннер тех. работ:** Градиент #ffc107 → #ff9800 (жёлтый)
- **Уведомление о звонке:** Градиент #1a1f35 → #2d3250 (тёмный)

### Анимации:
- ✨ Fade-in/out transitions
- 🔄 Пульсация иконок
- 📊 Прогресс-бар (30 секунд для звонка)
- 🌊 Волновой эффект на уведомлении

---

## 🆘 Troubleshooting:

**Баннер не появляется:**
- Проверьте API: `http://localhost:8080/api/maintenance/status`
- Очистите localStorage: `localStorage.removeItem('dismissedMaintenanceId')`

**Письма не отправляются:**
- Проверьте `.env` (EMAIL настройки)
- Проверьте логи Go сервера
- Убедитесь что роль admin/owner

**Звонок не приходит:**
- Проверьте WebSocket соединение (F12 → Network → WS)
- Убедитесь что оба пользователя онлайн
- Проверьте что WebRTC работает (HTTPS или localhost)

**Ошибка компиляции Go:**
- Запустите `go mod tidy`
- Перезапустите сервер

---

## 🎉 Готово!

**16 новых файлов создано:**
- 6 backend файлов (Go)
- 5 frontend файлов (React/TypeScript)
- 5 документаций

**4 основные функции добавлены:**
1. ✅ Персональные письма
2. ✅ Технические работы
3. ✅ Входящие звонки
4. ✅ Исправление дубликатов

**Всё готово к использованию! 🚀**

---

## 📚 Следующие шаги:

1. **Прочитайте:**
   - `ADMIN_MESSAGING_GUIDE.md` - подробная инструкция
   - `КРАТКАЯ_ИНСТРУКЦИЯ.txt` - быстрая памятка

2. **Протестируйте:**
   - Персональные письма (5 мин)
   - Технические работы (5 мин)
   - Входящие звонки (5 мин)

3. **Используйте:**
   - В production для уведомлений пользователей
   - Для плановых обслуживаний
   - Для персональной коммуникации

---

**Наслаждайтесь новыми возможностями! 🎊**
