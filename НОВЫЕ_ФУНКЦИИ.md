# 🎉 Новые функции SafeGram

## ✅ Что добавлено:

### 1. 📧 Персональные письма от администрации
- Администраторы могут отправлять персональные email пользователям
- Красивый дизайн в стиле SafeGram
- Опциональная кнопка с действием (например: "Открыть профиль")

### 2. 🔧 Система уведомлений о технических работах
- **Баннер вверху экрана** для всех пользователей
- Автоматическое отображение при активации
- **Можно закрыть** (состояние сохраняется)
- Опциональная email-рассылка всем пользователям

### 3. 📞 Исправлена система звонков
- ✅ Уведомление о входящем звонке с кнопками "Принять/Отклонить"
- ✅ Отображается имя и аватар звонящего
- ✅ Звуковой рингтон
- ✅ Автоотклонение через 30 секунд

### 4. 🔑 Исправлены дубликаты ключей React
- ✅ Больше нет warning про дублирующиеся keys
- ✅ Дедупликация при загрузке сообщений

---

## 🚀 Как использовать:

### 📧 Отправить персональное письмо:

1. Войдите как **администратор** или **владелец**
2. Откройте **"Панель управления"** (Admin Panel)
3. Перейдите на таб **"📧 Письма & Тех.работы"**
4. Выберите **"Персональные письма"**
5. Заполните форму:
   ```
   ID пользователя: user-123
   Сообщение: Ваш аккаунт был активирован!
   Текст кнопки: Открыть профиль
   Ссылка: https://safegram.app/profile
   ```
6. Нажмите **"Отправить письмо"**

**Результат:** Пользователь получит красивое письмо на email! 📨

---

### 🔧 Активировать технические работы:

1. В **"Панели управления"** → **"📧 Письма & Тех.работы"**
2. Переключитесь на **"Технические работы"**
3. Заполните форму:
   ```
   Время: 26 января 2024, с 02:00 до 04:00 (МСК)
   Описание: Обновление серверов. Доступ будет временно ограничен.
   ✓ Отправить email всем пользователям (по желанию)
   ```
4. Нажмите **"Активировать"**

**Результат:**
- ⚠️ **Все пользователи увидят жёлтый баннер вверху:**
  ```
  ┌──────────────────────────────────────────────┐
  │ ⚠️ Плановые технические работы            ❌ │
  │ ⏰ 26 января, с 02:00 до 04:00 (МСК)         │
  │ ℹ️ Обновление серверов...                    │
  └──────────────────────────────────────────────┘
  ```
- 📧 (Если выбрано) Все получат email-уведомление

### Отключить технические работы:

1. В той же форме нажмите **"Отключить"**
2. Баннер **исчезнет** у всех пользователей

---

## 📱 Как выглядит для пользователей:

### Баннер о технических работах:
- 🟡 **Жёлтый градиент** (привлекает внимание)
- ⚠️ **Иконка с анимацией** (пульсация)
- ⏰ **Время работ** четко указано
- ℹ️ **Описание** что будет недоступно
- ❌ **Кнопка закрыть** (можно скрыть баннер)

### Персональное письмо:
```
╔══════════════════════════════════════╗
║     SafeGram (красивый градиент)     ║
╠══════════════════════════════════════╣
║ 📨 Сообщение от администрации        ║
║                                      ║
║ Здравствуйте, Иван!                  ║
║                                      ║
║ У нас есть для вас важное сообщение: ║
║                                      ║
║ ┌────────────────────────────────┐   ║
║ │ Ваше персональное сообщение    │   ║
║ │ от администратора здесь        │   ║
║ └────────────────────────────────┘   ║
║                                      ║
║      [Кнопка с действием]            ║
║                                      ║
║ ────────────────────────────────     ║
║ SafeGram - Безопасный мессенджер     ║
╚══════════════════════════════════════╝
```

---

## 📂 Созданные/изменённые файлы:

### Backend (Go):
1. ✅ `server-go/internal/email/templates.go` - добавлены 2 новых шаблона
2. ✅ `server-go/internal/email/email.go` - добавлены функции отправки
3. ✅ `server-go/internal/models/maintenance.go` - **НОВЫЙ** модель для тех. работ
4. ✅ `server-go/internal/api/admin_messages.go` - **НОВЫЙ** API endpoints
5. ✅ `server-go/internal/api/routes.go` - добавлены роуты
6. ✅ `server-go/internal/database/migrations.go` - добавлена миграция

### Frontend (React):
1. ✅ `web/src/components/MaintenanceBanner.tsx` - **НОВЫЙ** баннер о тех. работах
2. ✅ `web/src/components/admin/AdminMessaging.tsx` - **НОВЫЙ** интерфейс управления
3. ✅ `web/src/pages/AppShell.tsx` - добавлен баннер
4. ✅ `web/src/pages/admin/Admin.tsx` - добавлен таб
5. ✅ `web/src/components/admin/index.ts` - экспорт компонента

### Также были исправлены:
6. ✅ `web/src/components/IncomingCallNotification.tsx` - **НОВЫЙ** уведомление о звонке
7. ✅ `web/src/components/DMCall.tsx` - передача информации о звонящем
8. ✅ `web/src/components/EnhancedChatWindow.tsx` - исправлены дубликаты

### Документация:
9. ✅ `ADMIN_MESSAGING_GUIDE.md` - подробная инструкция
10. ✅ `ИСПРАВЛЕНИЯ_ЗВОНКИ.md` - информация о звонках
11. ✅ `НОВЫЕ_ФУНКЦИИ.md` - этот файл

---

## 🧪 Как протестировать:

### 1. Запустите сервер:
```bash
cd "C:\Users\Lev\Desktop\Проекты\SafeGram перезапуск\server-go"
go run main.go
```

### 2. Запустите фронтенд:
```bash
cd "C:\Users\Lev\Desktop\Проекты\SafeGram перезапуск\web"
npm run dev
```

### 3. Тест персонального письма:
1. Войдите как администратор
2. Панель управления → "📧 Письма & Тех.работы"
3. Отправьте письмо себе
4. Проверьте email

### 4. Тест технических работ:
1. В той же панели переключитесь на "Технические работы"
2. Заполните форму:
   - Время: "Тестовые работы, прямо сейчас"
   - Описание: "Тестирование системы уведомлений"
3. Нажмите "Активировать" (БЕЗ отправки email)
4. **Откройте сайт в новой вкладке/инкогнито**
5. ✅ Должен появиться **жёлтый баннер вверху**
6. Закройте баннер крестиком
7. Обновите страницу - баннер не появится (запомнил)
8. Вернитесь в админку и нажмите "Отключить"

### 5. Тест входящего звонка:
1. Откройте 2 вкладки с разными аккаунтами
2. Из первой позвоните во вторую
3. ✅ Во второй вкладке появится **уведомление о звонке**
4. Нажмите "Принять" или "Отклонить"

---

## 📋 API Endpoints:

### Персональные письма:
```bash
POST /api/admin/send-email          # Одному пользователю
POST /api/admin/broadcast-email     # Нескольким пользователям
```

### Технические работы:
```bash
POST /api/admin/maintenance         # Активировать режим
GET  /api/maintenance/status        # Проверить статус (публичный!)
POST /api/admin/maintenance/disable # Отключить режим
```

---

## ⚠️ Важные замечания:

### Персональные письма:
- ✅ Требуют роль `admin` или `owner`
- ✅ Отправляются через SMTP (настройки в `.env`)
- ✅ Могут включать кнопку с действием
- ⚠️ Не сохраняются в базе данных

### Технические работы:
- ✅ Требуют роль `admin` или `owner`
- ✅ Статус сохраняется в базе данных
- ✅ Публичный endpoint для проверки статуса
- ⚠️ Email-рассылка опциональна (может занять время)
- ⚠️ Баннер можно закрыть (состояние в localStorage)

### Баннер:
- ✅ Отображается на **всех страницах**
- ✅ Проверяет статус **каждые 5 минут**
- ✅ **z-index: 9998** (поверх почти всего)
- ✅ **Адаптивный** для мобильных устройств
- ⚠️ Закрытие сохраняется по ID (новая активация покажет снова)

---

## 🎨 Дизайн:

### Email-шаблоны:
- 🌙 **Тёмная тема** в стиле SafeGram
- 🌈 **Градиенты** (#7c6cff → #3dd8ff)
- 📱 **Адаптивная вёрстка**
- ✨ **Красивые кнопки** с тенями
- 📦 **Информационные блоки**

### Баннер:
- 🟡 **Жёлто-оранжевый градиент**
- ⚠️ **Анимированная иконка**
- 📏 **Максимальная ширина 1200px**
- 📱 **Адаптивный padding** для мобильных

---

## 🚀 Готово к использованию!

Теперь администраторы могут:
- ✅ Отправлять персональные письма пользователям
- ✅ Уведомлять всех о технических работах
- ✅ Управлять баннером на сайте
- ✅ Видеть статистику отправки писем

**Все работает! 🎊**

---

## 📚 Дополнительная документация:

- **ADMIN_MESSAGING_GUIDE.md** - подробное руководство с примерами API
- **ИСПРАВЛЕНИЯ_ЗВОНКИ.md** - информация о системе звонков
- **QUICK_EMAIL_TEMPLATES.md** - все email-шаблоны SafeGram

---

## 💡 Советы по использованию:

### Когда отправлять персональные письма:
- 🎯 Ответы на обращения в поддержку
- 🎁 Персональные промо-коды
- 🔓 Активация специальных функций
- ⚠️ Важные уведомления конкретному пользователю

### Когда активировать режим тех. работ:
- 🔧 Плановое обновление серверов
- 💾 Миграция базы данных
- 🔄 Обновление функционала
- 🐛 Срочное исправление критических багов

### Best practices:
- 📅 **За день** до работ активируйте с email-рассылкой
- ⏰ **Указывайте точное время** (с часовым поясом!)
- 📝 **Описывайте понятно** что будет недоступно
- ✅ **Отключайте сразу** после завершения работ

---

**Тестируйте и используйте! 🚀📧🔧**
